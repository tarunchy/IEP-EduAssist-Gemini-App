<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart IEP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <h1>Parent Teacher Discussion - Smart IEP</h1>

    <div class="checkbox-label">
        <label for="consent">Parent's Consent:</label>
        <input type="checkbox" id="consent">
        <button class="small-button" id="start">Start Recording</button>
        <button class="small-button" id="stop">Stop Recording</button>
        <span id="status"><i id="mic-icon" class="fas fa-microphone"></i></span>
    </div>

    <label for="age">Select Age:</label>
    <select id="age">
        <option value="" disabled selected>Select Age</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
    </select>
    

    <label for="student_type">Select Student Type:</label>
    <select id="student_type">
        <option value="" disabled selected>Select Student Type</option>
        <option value="typical">Typical</option>
        <option value="special_need">Special Need</option>
    </select>

    <button id="loadQuestions">Load Questions</button>

    <div id="questions"></div>

    <div>
        <button class="small-button" id="clear">Clear Transcript</button>
        <button class="small-button" id="generate">Generate IEP</button>
    </div>

    <script>
        $(document).ready(function() {
    $('#loadQuestions').click(function() {
        var age = $('#age').val();
        var student_type = $('#student_type').val();
        $.ajax({
            url: '/get_iep_template',
            type: 'GET',
            data: {age: age, student_type: student_type},
            success: function(data) {
                var questionsHtml = '';
                // Take the array directly from the object
                var questionsArray = Object.values(data)[0]; // take the first (and possibly only) value
                if (questionsArray) {
                    questionsArray.forEach(function(question, index) {
                        questionsHtml += '<div class="question">' +
                                         '<input type="checkbox" id="question' + index + '" class="question-checkbox">' +
                                         '<label for="question' + index + '">' + (index + 1) + '. ' + question.question + '</label>' +
                                         '<textarea id="transcript' + index + '" rows="2" placeholder="Your speech will appear here"></textarea>' +
                                         '</div>';
                    });
                    $('#questions').html(questionsHtml);
                } else {
                    alert('No questions found for this age and student type');
                }
            },
            error: function(error) {
                alert('Error loading questions');
            }
        });
    });
});

    </script>

<script>
    $(document).ready(function() {
        var recognition; // SpeechRecognition object
        var isRecording = false;
        var selectedQuestionIndex = null;

        try {
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            // Allow for continuous recognition
            recognition.continuous = true;
        }
        catch(e) {
            alert('SpeechRecognition not supported by this browser.');
            return;
        }

        recognition.onstart = function() {
            isRecording = true;
            document.getElementById('mic-icon').classList.add("recording-icon"); // Add recording animation
        };

        recognition.onresult = function(event) {
            if (selectedQuestionIndex !== null) {
                var transcriptTextarea = $('#transcript' + selectedQuestionIndex);
                var newTranscript = '';
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    newTranscript += event.results[i][0].transcript;
                }
                transcriptTextarea.val(transcriptTextarea.val() + ' ' + newTranscript);
            }
        };


        recognition.onend = function() {
            isRecording = false;
            document.getElementById('mic-icon').classList.remove("recording-icon"); // Remove recording animation
        };

        $('#start').click(function() {
            if (isRecording) {
                return;
            }

            selectedQuestionIndex = null;
            $('.question-checkbox').each(function(index) {
                if ($(this).prop('checked')) {
                    selectedQuestionIndex = index;
                }
            });

            if (selectedQuestionIndex === null) {
                alert('Please select a question first.');
                return;
            }

            recognition.start();
        });

        $('#stop').click(function() {
            recognition.stop();
        });

        $('#loadQuestions').click(function() {
            var age = $('#age').val();
            var student_type = $('#student_type').val();
            $.ajax({
                url: '/get_iep_template',  // replace with your API endpoint
                type: 'GET',
                data: {age: age, student_type: student_type},
                success: function(data) {
                    var questionsHtml = '';
                    data.questions.forEach(function(question, index) {
                        questionsHtml += '<div class="question">' + 
                                         '<input type="checkbox" id="question' + index + '" class="question-checkbox">' +
                                         '<label for="question' + index + '">' + (index + 1) + '. ' + question.text + '</label>' + 
                                         '<textarea id="transcript' + index + '" rows="2" placeholder="Your speech will appear here"></textarea>' +
                                         '</div>';
                    });
                    $('#questions').html(questionsHtml);
                },
                error: function(error) {
                    alert('Error loading questions');
                }
            });
        });
    });
</script>

</body>
</html>
